# 对话记忆和搜索功能 - 使用说明

## 🎉 新增功能

你的 Claude 网页版现在支持**对话记忆持久化**和**对话搜索**功能！

## ✨ 功能特性

### 1. 对话持久化 💾
- **自动保存**：所有对话自动保存到 SQLite 数据库
- **刷新保留**：刷新页面后自动加载历史对话
- **跨会话**：关闭浏览器后再次打开，历史记录依然存在
- **用户隔离**：每个用户的对话独立存储

### 2. 对话搜索 🔍
- **关键词搜索**：快速查找包含特定关键词的对话
- **高亮显示**：搜索结果中关键词高亮显示
- **上下文预览**：显示匹配内容的上下文
- **时间戳**：每条结果显示对话时间

### 3. 历史记录查看 📜
- **完整历史**：查看最近 100 条对话记录
- **时间排序**：按时间倒序显示
- **角色标识**：清晰区分用户和 Claude 的消息
- **内容预览**：长消息自动截断显示

## 🚀 使用方法

### 对话持久化
对话会自动保存，无需任何操作：

1. **发送消息**：正常与 Claude 对话
2. **自动保存**：每条消息自动保存到数据库
3. **刷新页面**：页面刷新后自动加载最近 50 条历史
4. **继续对话**：可以基于历史记录继续对话

### 搜索对话
点击右上角的 🔍 按钮：

1. **打开搜索框**：点击搜索图标
2. **输入关键词**：输入要搜索的内容
3. **查看结果**：
   - 显示匹配数量
   - 关键词高亮显示
   - 显示对话时间和角色
   - 显示上下文片段

**快捷键**：在搜索框中按 Enter 键执行搜索

### 查看历史
点击右上角的 📜 按钮：

1. **打开历史面板**：点击历史图标
2. **浏览记录**：
   - 显示最近 100 条对话
   - 按时间倒序排列
   - 区分用户和 Claude 消息
   - 显示完整时间戳

### 清除历史
点击右上角的 🗑️ 按钮：

1. **确认清除**：弹出确认对话框
2. **清空数据**：清除数据库中的所有历史记录
3. **新会话**：生成新的会话 ID

## 📊 数据存储

### 数据库位置
```
/root/claude-web/conversations.db
```

### 数据结构
每条消息包含：
- **id**：消息唯一标识
- **username**：用户名
- **role**：角色（user/assistant）
- **content**：消息内容
- **model**：使用的模型
- **timestamp**：时间戳
- **session_id**：会话 ID

### 存储容量
- SQLite 数据库，理论上可存储数百万条消息
- 建议定期清理旧数据以保持性能

## 🔧 技术实现

### 后端新增
1. **database.py**：数据库操作模块
   - `init_db()`：初始化数据库
   - `save_message()`：保存消息
   - `get_conversation_history()`：获取历史
   - `search_conversations()`：搜索对话
   - `clear_user_history()`：清除历史

2. **新增 API 端点**：
   - `GET /api/history`：获取历史记录
   - `POST /api/search`：搜索对话
   - `GET /api/stats`：获取统计信息
   - `POST /api/clear`：清除历史（已更新）

### 前端新增
1. **搜索对话框**：模态窗口，支持关键词搜索
2. **历史记录面板**：显示完整对话历史
3. **自动加载**：页面加载时自动获取历史
4. **实时保存**：发送消息时自动保存到数据库

## 📝 使用示例

### 示例 1：搜索技术问题
```
1. 点击 🔍 搜索按钮
2. 输入 "Python"
3. 查看所有包含 "Python" 的对话
```

### 示例 2：查看昨天的对话
```
1. 点击 📜 历史按钮
2. 浏览时间戳
3. 找到昨天的对话记录
```

### 示例 3：继续之前的话题
```
1. 刷新页面
2. 自动加载历史记录
3. 基于上下文继续对话
```

## 🎯 最佳实践

### 性能优化
- **定期清理**：定期清除不需要的历史记录
- **限制加载**：默认只加载最近 50 条消息
- **按需搜索**：使用搜索功能查找特定内容

### 数据管理
- **备份数据库**：定期备份 `conversations.db` 文件
- **导出重要对话**：使用导出功能保存重要对话
- **清理旧数据**：定期清除过期的对话记录

### 隐私保护
- **本地存储**：所有数据存储在本地服务器
- **用户隔离**：不同用户的数据完全隔离
- **安全清除**：清除历史会永久删除数据

## 🔒 安全说明

1. **数据隔离**：每个用户只能访问自己的对话
2. **会话验证**：所有 API 都需要登录验证
3. **SQL 注入防护**：使用参数化查询防止注入
4. **本地存储**：数据不会上传到外部服务器

## 🐛 故障排查

### 历史记录不显示
```bash
# 检查数据库文件
ls -lh /root/claude-web/conversations.db

# 检查数据库内容
sqlite3 /root/claude-web/conversations.db "SELECT COUNT(*) FROM conversations;"
```

### 搜索功能不工作
```bash
# 检查应用日志
tail -f /tmp/claude-0/-root-claude-web/tasks/*.output

# 重启应用
./stop.sh && ./start.sh
```

### 数据库损坏
```bash
# 备份旧数据库
mv conversations.db conversations.db.bak

# 重新初始化
python3 -c "import database; database.init_db()"
```

## 📈 统计信息

可以通过 API 获取统计信息：

```bash
curl -X GET http://localhost:5000/api/stats \
  -H "Cookie: session=YOUR_SESSION_COOKIE"
```

返回信息包括：
- 总消息数
- 总会话数
- 首次对话时间
- 最后对话时间

## 🎊 总结

现在你的 Claude 网页版拥有完整的记忆功能：

✅ **自动保存**：所有对话自动持久化
✅ **快速搜索**：关键词搜索，高亮显示
✅ **历史查看**：完整的对话历史记录
✅ **跨会话**：刷新页面不丢失数据
✅ **用户隔离**：多用户数据独立存储

**立即体验：** http://localhost:5000

祝使用愉快！🚀
